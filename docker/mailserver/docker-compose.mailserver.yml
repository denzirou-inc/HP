# docker-compose.mailserver.yml - „É°„Éº„É´„Çµ„Éº„Éê„ÉºÁî®Ë®≠ÂÆö
# Sakura VPS UbuntuÁí∞Â¢É„Åß„ÅÆdocker-mailserverÊßãÊàê

services:
  # „É°„Éº„É´„Éú„ÉÉ„ÇØ„ÇπÂàùÊúüÂåñ„Ç≥„É≥„ÉÜ„Éä
  mailserver-init:
    image: alpine:latest
    container_name: mailserver-init
    volumes:
      - ./data/dms/mail-data/:/mail-data/
      - ./data/dms/mail-state/:/mail-state/
      - ./data/dms/config/:/config/
    command: >
      sh -c "
        echo 'üîß Mailserver initialization starting...';
        
        # „É°„Éº„É´„Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÈÄ†‰ΩúÊàê
        echo 'üìÅ Creating mail directory structure...';
        mkdir -p /mail-data/denzirou.com;
        chown -R 5000:5000 /mail-data;
        chmod -R 755 /mail-data;
        
        # Ë®≠ÂÆö„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÊ®©ÈôêË®≠ÂÆö
        echo 'üîê Setting config directory permissions...';
        chown -R root:root /config;
        chmod -R 644 /config;
        
        # ÂàùÊúüÂåñÂÆå‰∫Ü„Éû„Éº„Ç´„Éº‰ΩúÊàê
        echo '‚úÖ Initialization completed at $(date)' > /mail-data/.initialized;
        echo '‚úÖ Mailserver initialization completed successfully!';
      "
    restart: "no"
    networks:
      - mailserver-network

  mailserver:
    image: docker.io/mailserver/docker-mailserver:latest
    container_name: mailserver
    hostname: mail.denzirou.com
    domainname: denzirou.com
    depends_on:
      mailserver-init:
        condition: service_completed_successfully
    ports:
      # SMTP
      - "25:25"
      - "465:465"
      - "587:587"
      # IMAP
      - "993:993"
    volumes:
      - ./data/dms/mail-data/:/var/mail/
      - ./data/dms/mail-state/:/var/mail-state/
      - ./data/dms/mail-logs/:/var/log/mail/
      - ./data/dms/config/:/tmp/docker-mailserver/
      - /etc/letsencrypt/live/mail.denzirou.com/fullchain.pem:/etc/ssl/certs/mailserver.crt:ro
      - /etc/letsencrypt/live/mail.denzirou.com/privkey.pem:/etc/ssl/private/mailserver.key:ro
      - ./security/fail2ban-custom.conf:/etc/fail2ban/jail.d/custom.conf:ro
      - ./security/fail2ban-filters.conf:/etc/fail2ban/filter.d/custom.conf:ro
      - ./security/postfix-security.cf:/tmp/docker-mailserver/postfix-main.cf:ro
# DovecotË®≠ÂÆö„ÇíÁÑ°ÂäπÂåñÔºà‰∫íÊèõÊÄßÂïèÈ°å„ÅÆ„Åü„ÇÅÔºâ
      # - ./security/dovecot-security.cf:/tmp/docker-mailserver/dovecot.cf:ro
      - ./init-hooks/:/tmp/docker-mailserver/custom-init.d/:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      # General Security (RspamdÁµ±‰∏ÄÊßãÊàê) - „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÈáçË¶ñ
      - ENABLE_RSPAMD=1
      - ENABLE_CLAMAV=0
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=0
      - ENABLE_SPAMASSASSIN=0
      - ENABLE_DNSBL=0
      - ENABLE_AMAVIS=0
      - ENABLE_OPENDKIM=0
      - ENABLE_OPENDMARC=0
      - ENABLE_POLICYD_SPF=0

      # SSL/TLS Security
      - SSL_TYPE=manual
      - SSL_CERT_PATH=/etc/ssl/certs/mailserver.crt
      - SSL_KEY_PATH=/etc/ssl/private/mailserver.key
      - TLS_LEVEL=intermediate
      - POSTFIX_INET_PROTOCOLS=ipv4

      # Authentication & Access Control
      - ENABLE_SASLAUTHD=0
      - DOVECOT_MAILBOX_FORMAT=maildir
      - DOVECOT_TLS=yes
      - POSTFIX_REJECT_UNKNOWN_CLIENT_HOSTNAME=1
      - POSTFIX_REJECT_UNKNOWN_HELO_HOSTNAME=1
      - POSTFIX_REJECT_UNKNOWN_SENDER_DOMAIN=1
      - POSTFIX_REJECT_UNKNOWN_RECIPIENT_DOMAIN=1

      # Rate Limiting & Anti-Abuse
      - POSTFIX_MESSAGE_SIZE_LIMIT=25600000
      - POSTFIX_MAILBOX_SIZE_LIMIT=536870912
      - ENABLE_QUOTAS=1
      - QUOTA_TYPE=maildir++
      - DEFAULT_QUOTA=500M

      # Network Security
      - PERMIT_DOCKER=network
      - ONE_DIR=1
      - POSTMASTER_ADDRESS=postmaster@denzirou.com
      - RELAY_HOST=
      - DOVECOT_INET_PROTOCOLS=ipv4

      # Advanced Security
      - ENABLE_UPDATE_CHECK=1
      - UPDATE_CHECK_INTERVAL=1d
      - LOGROTATE_INTERVAL=weekly
      - LOGWATCH=off
      - PFLOGSUMM_TRIGGER=logrotate

      # Ëá™Âãï„É°„Éº„É´„Éú„ÉÉ„ÇØ„Çπ‰ΩúÊàêË®≠ÂÆö
      - ENABLE_MANAGESIEVE=1
      - DOVECOT_MAILBOX_AUTOCREATE=yes
      - DOVECOT_MAILBOX_SUBSCRIBE=yes

    cap_add:
      - NET_ADMIN
    restart: unless-stopped
    stop_grace_period: 1m
    deploy:
      resources:
        limits:
          memory: 800M
        reservations:
          memory: 400M
    healthcheck:
      test: "ss -lntp | grep -E ':25|:465|:587|:993' || exit 1"
      timeout: 45s
      interval: 30s
      retries: 3
      start_period: 120s
    networks:
      - mailserver-network

# SSLË®ºÊòéÊõ∏„ÅØ„Ç∑„Çπ„ÉÜ„É†„ÅÆCertbot„ÅßÁÆ°ÁêÜ

networks:
  mailserver-network:
    driver: bridge