name: Deploy

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "DEPLOY_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "DEPLOY_ENV=production" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa_denzirou
          chmod 600 ~/.ssh/id_rsa_denzirou
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: Deploy to ${{ steps.set-env.outputs.DEPLOY_ENV }}
        run: |
          DEPLOY_ENV="${{ steps.set-env.outputs.DEPLOY_ENV }}"

          if [ "$DEPLOY_ENV" == "production" ]; then
            REMOTE_PATH="/opt/denzirou-multi-env/production/"
            COMPOSE_FILE="docker/docker-compose.production.yml"
            PROJECT_NAME="denzirou-production"
            CONTAINER_NAME="denzirou-prod-web"
            HEALTH_PORT="8080"
          else
            REMOTE_PATH="/opt/denzirou-multi-env/development/"
            COMPOSE_FILE="docker/docker-compose.development.yml"
            PROJECT_NAME="denzirou-development"
            CONTAINER_NAME="denzirou-dev-web"
            HEALTH_PORT="8081"
          fi

          echo "ğŸš€ ${DEPLOY_ENV}ç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™"

          # ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€
          echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€ä¸­..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa_denzirou -o StrictHostKeyChecking=no" \
            --exclude-from="deploy/config/rsync-exclude.txt" \
            ./ \
            "admin@denzirou.com:${REMOTE_PATH}"

          # ãƒªãƒ¢ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
          ssh -i ~/.ssh/id_rsa_denzirou -o StrictHostKeyChecking=no admin@denzirou.com << EOF
            cd ${REMOTE_PATH}

            # æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
            docker compose -f ${COMPOSE_FILE} -p ${PROJECT_NAME} down || true

            # æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
            docker compose -f ${COMPOSE_FILE} -p ${PROJECT_NAME} up -d --build

            # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¾…æ©Ÿ
            echo "ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¾…æ©Ÿä¸­..."
            sleep 10

            # ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
            if ! docker ps | grep -q "${CONTAINER_NAME}"; then
              echo "âŒ Webã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"
              docker ps | grep ${PROJECT_NAME}
              exit 1
            fi
            echo "âœ… Docker ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª"

            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
            for i in {1..18}; do
              if curl -f -s http://localhost:${HEALTH_PORT}/health >/dev/null 2>&1; then
                echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
                exit 0
              fi
              if [ \$i -eq 18 ]; then
                echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
                docker logs ${CONTAINER_NAME} | tail -10
                exit 1
              fi
              echo "å¾…æ©Ÿä¸­... (\$i/18)"
              sleep 5
            done
          EOF

          echo "ğŸ‰ ${DEPLOY_ENV}ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
